<!--pages/add-asset/add-asset.wxml-->
<view class="container">
  <form class="asset-form">
    <!-- 资产名称 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">资产名称</text>
        <text class="required">*</text>
      </view>
      <input 
        class="form-input {{errors.name ? 'error' : ''}}"
        placeholder="请输入资产名称"
        value="{{formData.name}}"
        data-field="name"
        bindinput="onInputChange"
        bindblur="onInputChange"
        maxlength="50"
        focus="{{false}}"
        confirm-type="next"
      />
      <text class="error-text" wx:if="{{errors.name}}">{{errors.name}}</text>
    </view>

    <!-- 资产分类 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">资产分类</text>
        <text class="required">*</text>
      </view>
      <view class="category-selector {{errors.category ? 'error' : ''}}" bindtap="showCategoryPicker">
        <view class="category-display">
          <image wx:if="{{formData.category}}" class="category-icon" src="{{categories[categoryIndex].icon}}" mode="aspectFit"></image>
          <text>{{formData.category || '请选择分类'}}</text>
        </view>
        <text class="selector-arrow"></text>
      </view>
      <text class="error-text" wx:if="{{errors.category}}">{{errors.category}}</text>
    </view>

    <!-- 持有金额 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">持有金额</text>
        <text class="required">*</text>
      </view>
      <input 
        class="form-input number {{errors.amount ? 'error' : ''}}"
        type="digit"
        placeholder="请输入持有金额"
        value="{{formData.amount}}"
        data-field="amount"
        bindinput="onNumberInput"
      />
      <text class="error-text" wx:if="{{errors.amount}}">{{errors.amount}}</text>
    </view>

    <!-- 持有日期 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">持有日期</text>
        <text class="required">*</text>
      </view>
      <picker 
        mode="date" 
        value="{{formData.purchaseDate}}" 
        end="{{maxDate}}"
        bindchange="onDateChange"
        class="date-picker"
      >
        <view class="date-display {{errors.purchaseDate ? 'error' : ''}}">
          <text class="date-text">{{formData.purchaseDate || '请选择日期'}}</text>
          <text class="selector-arrow"></text>
        </view>
      </picker>
      <text class="error-text" wx:if="{{errors.purchaseDate}}">{{errors.purchaseDate}}</text>
    </view>

    <!-- 预计估值 -->
    <view class="form-group">
      <view class="form-label-with-btn">
        <view class="form-label">
          <text class="label-text">预计估值</text>
          <text class="optional">（选填）</text>
        </view>
        <button 
          class="ai-estimate-header-btn" 
          wx:if="{{hasApiKey && formData.name && formData.amount && formData.purchaseDate}}" 
          bindtap="performAIEstimate" 
          disabled="{{isEstimating}}"
        >
          <text class="ai-icon">🤖</text>
          <text>{{isEstimating ? 'AI估值中...' : 'AI估值'}}</text>
        </button>
      </view>
      <view class="value-input-container">
        <input 
          class="form-input number {{errors.currentValue ? 'error' : ''}}"
          type="digit"
          placeholder="不填则显示原价"
          value="{{formData.currentValue}}"
          data-field="currentValue"
          bindinput="onNumberInput"
        />
      </view>
      <text class="error-text" wx:if="{{errors.currentValue}}">{{errors.currentValue}}</text>
      <text class="form-hint" wx:if="{{aiEstimateResult}}">AI估值建议：{{aiEstimateResult}}</text>
    </view>

    <!-- 备注 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">备注</text>
        <text class="optional">（可选）</text>
      </view>
      <textarea 
        class="form-textarea"
        placeholder="添加备注信息..."
        value="{{formData.remark}}"
        data-field="remark"
        bindinput="onInputChange"
        bindblur="onInputChange"
        maxlength="200"
        auto-height
        focus="{{false}}"
        confirm-type="done"
      />
    </view>

    <!-- 操作按钮 -->
    <view class="form-actions">
      <button class="btn btn-secondary" bindtap="resetForm">
        {{isEdit ? '删除' : '重置'}}
      </button>
      <button class="btn btn-primary" bindtap="saveAsset">
        {{isEdit ? '更新资产' : '添加资产'}}
      </button>
    </view>
  </form>

  <!-- 分类选择器弹窗 -->
  <view class="category-drawer {{showCategoryPicker ? 'show' : ''}}" wx:if="{{showCategoryPicker}}">
    <!-- 抽屉头部 -->
    <view class="drawer-header">
      <text class="drawer-title">选择分类</text>
      <view class="close-btn" bindtap="onCategoryCancel">✕</view>
    </view>
    
    <!-- 添加新分类区域 -->
    <view class="add-category-section">
      <view class="section-title">新增分类</view>
      <view class="add-category-form">
        <input 
          class="category-input" 
          placeholder="输入分类名称" 
          value="{{newCategoryName}}"
          bindinput="onNewCategoryInput"
          maxlength="10"
        />
        <button class="add-btn" bindtap="addNewCategory">添加</button>
      </view>
    </view>
    
    <!-- 已有分类区域 -->
    <view class="existing-categories-section">
      <view class="section-title">已有分类</view>
      <view class="categories-grid">
        <view 
          class="category-item {{categoryIndex === index ? 'selected' : ''}}" 
          wx:for="{{categories}}" 
          wx:key="key"
          wx:for-index="index"
          data-index="{{index}}"
          bindtap="onCategorySelect"
        >
          <image class="category-item-icon" src="{{item.icon}}" mode="aspectFit"></image>
          <text class="category-item-name">{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 遮罩层 -->
  <view class="picker-mask {{showCategoryPicker ? 'show' : ''}}" bindtap="onCategoryCancel" wx:if="{{showCategoryPicker}}"></view>
</view>