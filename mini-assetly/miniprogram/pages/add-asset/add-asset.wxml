<!--pages/add-asset/add-asset.wxml-->
<view class="container">
  <form class="asset-form">
    <!-- 资产名称 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">资产名称</text>
        <text class="required">*</text>
      </view>
      <input 
        class="form-input {{errors.name ? 'error' : ''}}"
        placeholder="请输入资产名称"
        value="{{formData.name}}"
        data-field="name"
        bindinput="onInputChange"
        bindblur="onInputChange"
        maxlength="50"
        focus="{{false}}"
        confirm-type="next"
      />
      <text class="error-text" wx:if="{{errors.name}}">{{errors.name}}</text>
    </view>

    <!-- 资产分类 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">资产分类</text>
        <text class="required">*</text>
      </view>
      <view class="category-selector {{errors.category ? 'error' : ''}}" bindtap="showCategoryPicker">
        <view class="category-display">
          <view wx:if="{{formData.category}}" class="category-icon" style="background-color: {{categories[categoryIndex].color}}">
          </view>
          <text>{{formData.category || '请选择分类'}}</text>
        </view>
        <text class="selector-arrow"></text>
      </view>
      <text class="error-text" wx:if="{{errors.category}}">{{errors.category}}</text>
    </view>

    <!-- 持有金额 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">持有金额</text>
        <text class="required">*</text>
      </view>
      <input 
        class="form-input number {{errors.amount ? 'error' : ''}}"
        type="digit"
        placeholder="请输入持有金额"
        value="{{formData.amount}}"
        data-field="amount"
        bindinput="onNumberInput"
      />
      <text class="error-text" wx:if="{{errors.amount}}">{{errors.amount}}</text>
    </view>

    <!-- 持有日期 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">持有日期</text>
        <text class="required">*</text>
      </view>
      <picker 
        mode="date" 
        value="{{formData.purchaseDate}}" 
        end="{{maxDate}}"
        bindchange="onDateChange"
        class="date-picker"
      >
        <view class="date-display {{errors.purchaseDate ? 'error' : ''}}">
          <text class="date-text">{{formData.purchaseDate || '请选择日期'}}</text>
          <text class="selector-arrow"></text>
        </view>
      </picker>
      <text class="error-text" wx:if="{{errors.purchaseDate}}">{{errors.purchaseDate}}</text>
    </view>

    <!-- 预计估值 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">预计估值</text>
        <text class="optional">（选填）</text>
      </view>
      <view class="value-input-container">
        <input 
          class="form-input number {{errors.currentValue ? 'error' : ''}}"
          type="digit"
          placeholder="不填则显示原价"
          value="{{formData.currentValue}}"
          data-field="currentValue"
          bindinput="onNumberInput"
        />
        <button class="ai-estimate-btn" wx:if="{{hasApiKey}}" bindtap="performAIEstimate" disabled="{{isEstimating}}">
          <text class="ai-icon">🤖</text>
          <text>{{isEstimating ? 'AI估值中...' : 'AI估值'}}</text>
        </button>
      </view>
      <text class="error-text" wx:if="{{errors.currentValue}}">{{errors.currentValue}}</text>
      <text class="form-hint" wx:if="{{aiEstimateResult}}">AI估值建议：{{aiEstimateResult}}</text>
    </view>

    <!-- 备注 -->
    <view class="form-group">
      <view class="form-label">
        <text class="label-text">备注</text>
        <text class="optional">（可选）</text>
      </view>
      <textarea 
        class="form-textarea"
        placeholder="添加备注信息..."
        value="{{formData.remark}}"
        data-field="remark"
        bindinput="onInputChange"
        bindblur="onInputChange"
        maxlength="200"
        auto-height
        focus="{{false}}"
        confirm-type="done"
      />
    </view>

    <!-- 操作按钮 -->
    <view class="form-actions">
      <button class="btn btn-secondary" bindtap="resetForm" wx:if="{{!isEdit}}">
        重置
      </button>
      <button class="btn btn-primary" bindtap="saveAsset">
        {{isEdit ? '更新资产' : '添加资产'}}
      </button>
    </view>
  </form>

  <!-- 分类选择器 -->
  <picker-view 
    class="category-picker {{showCategoryPicker ? 'show' : ''}}"
    value="{{[categoryIndex]}}"
    bindchange="onCategoryChange"
    wx:if="{{showCategoryPicker}}"
  >
    <picker-view-column>
      <view class="picker-item" wx:for="{{categories}}" wx:key="key">
        <view class="category-option">
          <view class="category-color" style="background-color: {{item.color}}"></view>
          <text class="category-name">{{item.name}}</text>
        </view>
      </view>
    </picker-view-column>
  </picker-view>

  <!-- 遮罩层 -->
  <view class="picker-mask {{showCategoryPicker ? 'show' : ''}}" bindtap="onCategoryCancel" wx:if="{{showCategoryPicker}}"></view>
</view>